<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>spotDL Web Downloader</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --primary-color: #1db954;
                --background-color: #121212;
                --surface-color: #1e1e1e;
                --text-color: #ffffff;
                --text-secondary-color: #b3b3b3;
                --container-padding: 2rem;
                --container-color: #2c2c2c;
            }

            body {
                font-family: "Roboto", sans-serif;
                background-color: var(--background-color);
                color: var(--text-color);
                margin: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }

            .container {
                width: 90%;
                max-width: 600px;
                height: 90vh;
                background-color: var(--surface-color);
                border-radius: 16px;
                padding: var(--container-padding);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                display: flex;
                flex-direction: column;
                margin: 1em;
            }

            h1 {
                text-align: center;
                font-weight: 700;
                margin-bottom: 2rem;
            }

            .input-group {
                display: flex;
                margin-bottom: 1em;
            }

            #url {
                flex-grow: 1;
                border: none;
                background-color: #2c2c2c;
                color: var(--text-color);
                padding: 1rem;
                border-radius: 1em;
                font-size: 1rem;
                margin-right: 1em;
            }

            #downloadBtn {
                border: none;
                background-color: var(--primary-color);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 1em;
                cursor: pointer;
                font-weight: 500;
                font-size: 1rem;
            }

            #playlist_input {
                border: none;
                background-color: #2c2c2c;
                color: var(--text-color);
                padding: 1rem;
                font-size: 1rem;
                border-radius: 1em;
                height: 1.2em;
                margin-bottom: 1em;
            }

            #downloadBtn:disabled {
                background-color: #666;
                cursor: not-allowed;
            }

            #notifyBtn {
                background-color: transparent;
                border: 1px solid var(--primary-color);
                color: var(--primary-color);
                padding: 0.5rem 1rem;
                border-radius: 1em;
                cursor: pointer;
                margin-bottom: 1em;
            }

            #progress-container {
                margin-top: 0rem;
                margin-bottom: 1em;
            }

            #progress-text {
                font-size: 1rem;
                color: var(--text-color);
                margin-bottom: 0.5rem;
                position: absolute;
                margin: 0.95em;
            }

            progress {
                width: 100%;
                height: 3em;
                appearance: none;
                border-radius: 1em;
                overflow: hidden;
                transition: all 0.3s ease;
                border: none;
                background-color: var(--container-color);
            }

            progress::-moz-progress-bar {
                background-color: var(--primary-color);
                border-radius: 1em;
            }

            progress::-webkit-progress-value {
                background-color: var(--primary-color);
                border-radius: 1em;
                transition: width 0.3s ease;
            }

            #terminal {
                width: 100%;
                flex-grow: 1;
                background-color: #2c2c2c;
                color: #0f0;
                border-radius: 1em;
                padding: 1rem;
                font-family: monospace;
                font-size: 0.8rem;
                border: none;
                box-sizing: border-box;
                resize: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>spotDL Downloader</h1>
            <div class="input-group">
                <input
                    type="text"
                    id="url"
                    placeholder="Enter Spotify URL here"
                />
                <button id="downloadBtn">Download</button>
            </div>
            <input
                id="playlist_input"
                type="text"
                placeholder="Playlist to add songs to (optional)"
            />
            <button id="notifyBtn">Enable Notifications</button>

            <div id="progress-container" style="display: none">
                <div id="progress-text">Progress: 0 / 0</div>
                <progress id="progress-bar" max="1" value="0"></progress>
            </div>

            <textarea id="terminal" readonly></textarea>
        </div>

        <script>
            const urlInput = document.getElementById("url");
            const playlistInput = document.getElementById("playlist_input");
            const downloadBtn = document.getElementById("downloadBtn");
            const progressContainer =
                document.getElementById("progress-container");
            const progressText = document.getElementById("progress-text");
            const progressBar = document.getElementById("progress-bar");
            const terminal = document.getElementById("terminal");
            const notifyBtn = document.getElementById("notifyBtn");

            let socket;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;

            function handleNotificationPermission() {
                if (Notification.permission === "granted") {
                    notifyBtn.style.display = "none";
                } else {
                    notifyBtn.style.display = "inline-block";
                }
            }

            notifyBtn.onclick = () => {
                Notification.requestPermission().then(() => {
                    handleNotificationPermission();
                    if (Notification.permission === "granted") {
                        new Notification("Notifications enabled!");
                    }
                });
            };

            handleNotificationPermission();

            function showNotification(title, body) {
                if (Notification.permission === "granted") {
                    new Notification(title, { body });
                }
            }

            function appendLog(text) {
                terminal.value += text + "\n";
                terminal.scrollTop = terminal.scrollHeight;
            }

            function setProgress(progress) {
                console.log("Setting progress:", progress);

                progressBar.classList.remove("loading");

                if (progress.total > 0) {
                    progressBar.max = progress.total;
                    progressBar.value = progress.current;
                    progressText.innerText = `[${progress.current} / ${progress.total}] ${progress.track}`;
                } else {
                    progressBar.max = 1;
                    progressBar.value = 0;
                    progressText.innerText = progress.track || "Starting...";
                }

                progressContainer.style.display = "block";
            }

            function resetProgress() {
                progressBar.classList.add("loading");
                progressBar.max = 1;
                progressBar.value = 0;
                progressText.innerText = "Starting download...";
                progressContainer.style.display = "block";
            }

            function connect() {
                try {
                    socket = new WebSocket(`ws://${window.location.host}/ws`);

                    socket.onopen = () => {
                        console.log("WebSocket connection established.");
                        reconnectAttempts = 0;
                        appendLog("Connected to server.");
                    };

                    socket.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            if (msg.type === "progress") {
                                setProgress(msg);
                            } else {
                                appendLog(event.data);
                            }
                        } catch (e) {
                            if (event.data === "[DONE]") {
                                appendLog("âœ… Download complete!");
                                showNotification(
                                    "Download Complete!",
                                    "Your music is ready.",
                                );
                                urlInput.disabled = false;
                                downloadBtn.disabled = false;
                                playlistInput.disabled = false;
                            } else {
                                appendLog(event.data);
                            }
                        }
                    };

                    socket.onerror = (err) => {
                        console.error("WebSocket error:", err);
                        appendLog("Connection error.");
                    };

                    socket.onclose = () => {
                        console.log("WebSocket connection closed.");
                        appendLog("Connection lost. Reconnecting...");

                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            setTimeout(connect, 5000);
                        } else {
                            appendLog(
                                "Failed to reconnect. Please refresh the page.",
                            );
                        }
                    };
                } catch (error) {
                    console.error("Connection error:", error);
                    appendLog("Failed to connect to server.");
                }
            }

            downloadBtn.onclick = () => {
                const url = urlInput.value.trim();
                const playlist = playlistInput.value.trim();
                if (!url) {
                    alert("Please enter a Spotify URL.");
                    return;
                }

                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    alert(
                        "Not connected to server. Please wait for connection.",
                    );
                    return;
                }

                terminal.value = "";
                resetProgress();

                try {
                    socket.send(url + "---" + playlist);
                    downloadBtn.disabled = true;
                    urlInput.disabled = true;
                    playlistInput.disabled = true;
                } catch (error) {
                    console.error("Send error:", error);
                    appendLog("Failed to send download request.");
                    downloadBtn.disabled = false;
                    urlInput.disabled = false;
                    playlistInput.disabled = false;
                }
            };

            // Initial connection
            connect();
        </script>
    </body>
</html>
