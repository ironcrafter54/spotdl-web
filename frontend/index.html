<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>spotDL Web Downloader</title>
        <link rel="stylesheet" href="/static/style.css?v=1.5" />
        <!-- Using system fonts instead of Google Fonts for better reliability -->
    </head>
    <body>
        <div class="header">
            <div class="title-card pixel-corners">
                <a href="spotdl">
                    <img src="/static/spotify logo.png" alt="" class="spotify">
                </a>
                <p class="title">SpotDL - Improved</p>
            </div>
            <button id="logoutBtn" class="logout pixel-corners">Logout</button>
        </div>
        <div class="content">
            <div class="inputs pixel-corners">
                <div id="progress-container" style="display: none">
                    <div id="progress-text">Progress: 0 / 0</div>
                    <div class="pixel-borders--wrapper">
                        <progress id="progress-bar" max="1" value="0"></progress>
                    </div>
                </div>
                <div class="pixel-borders--wrapper" style="margin-bottom: 20px; margin-top: 20px;">
    
                    <input
                    type="text"
                    id="url"
                    placeholder="Enter Spotify URL here"
                    class="param-input"
                    />
                </div>
    
                <div class="pixel-borders--wrapper" style="margin-bottom: 20px;">
    
                    <input
                    id="playlist_input"
                    type="text"
                    placeholder="Playlist to add songs to (optional)"
                    class="param-input"
                    />
                </div>
    
                <button id="notifyBtn" class="submit-btn pixel-corners" style="margin-top: 0px; margin-bottom: 20px;">Enable Notifications</button>
    
                <button id="downloadBtn"  class="submit-btn pixel-corners" style="margin-top: 0px; margin-bottom: 20px;">Download</button>
                
    
    
            </div>
    
            <div class="textarea pixel-corners">
                <div class="terminal-border">
                    <textarea id="terminal" class="terminal" disabled="true">
    
                    </textarea>
                </div>
            </div>
        </div>

        <script>
            const urlInput = document.getElementById("url");
            const playlistInput = document.getElementById("playlist_input");
            const downloadBtn = document.getElementById("downloadBtn");
            const progressContainer =
                document.getElementById("progress-container");
            const progressText = document.getElementById("progress-text");
            const progressBar = document.getElementById("progress-bar");
            const terminal = document.getElementById("terminal");
            const notifyBtn = document.getElementById("notifyBtn");

            let socket;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let sessionToken = null;

            // Get session token from cookies
            function getSessionToken() {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split("=");
                    if (name === "session_token") {
                        return value;
                    }
                }
                return null;
            }

            sessionToken = getSessionToken();

            // Logout functionality
            document.getElementById("logoutBtn").onclick = async () => {
                try {
                    await fetch("/logout", { method: "POST" });
                    window.location.href = "/login";
                } catch (error) {
                    console.error("Logout error:", error);
                    // Force redirect even if logout fails
                    window.location.href = "/login";
                }
            };

            function handleNotificationPermission() {
                if (Notification.permission === "granted") {
                    notifyBtn.style.display = "none";
                } else {
                    notifyBtn.style.display = "inline-block";
                }
            }

            notifyBtn.onclick = () => {
                Notification.requestPermission().then(() => {
                    handleNotificationPermission();
                    if (Notification.permission === "granted") {
                        new Notification("Notifications enabled!");
                    }
                });
            };

            handleNotificationPermission();

            function showNotification(title, body) {
                if (Notification.permission === "granted") {
                    new Notification(title, { body });
                }
            }

            function appendLog(text) {
                terminal.value += text + "\n";
                terminal.scrollTop = terminal.scrollHeight;
            }

            function setProgress(progress) {
                console.log("Setting progress:", progress);

                progressBar.classList.remove("loading");

                if (progress.total > 0) {
                    progressBar.max = progress.total;
                    progressBar.value = progress.current;
                    progressText.innerText = `[${progress.current} / ${progress.total}] ${progress.track}`;
                } else {
                    progressBar.max = 1;
                    progressBar.value = 0;
                    progressText.innerText = progress.track || "Starting...";
                }

                progressContainer.style.display = "block";
            }

            function resetProgress() {
                progressBar.classList.add("loading");
                progressBar.max = 1;
                progressBar.value = 0;
                progressText.innerText = "Starting download...";
                progressContainer.style.display = "block";
            }

            function connect() {
                try {
                    // Include session token in WebSocket connection
                    const wsUrl = `ws://${window.location.host}/ws?session_token=${sessionToken}`;
                    socket = new WebSocket(wsUrl);

                    socket.onopen = () => {
                        console.log("WebSocket connection established.");
                        reconnectAttempts = 0;
                        appendLog("Connected to server.");
                    };

                    socket.onmessage = (event) => {
                        try {
                            const msg = JSON.parse(event.data);
                            if (msg.type === "progress") {
                                setProgress(msg);
                            } else {
                                appendLog(event.data);
                            }
                        } catch (e) {
                            if (event.data === "[DONE]") {
                                appendLog("âœ… Download complete!");
                                showNotification(
                                    "Download Complete!",
                                    "Your music is ready.",
                                );
                                urlInput.disabled = false;
                                downloadBtn.disabled = false;
                                playlistInput.disabled = false;
                            } else {
                                appendLog(event.data);
                            }
                        }
                    };

                    socket.onerror = (err) => {
                        console.error("WebSocket error:", err);
                        appendLog("Connection error.");
                    };

                    socket.onclose = (event) => {
                        console.log("WebSocket connection closed.", event);

                        // If closed due to authentication (code 4001), redirect to login
                        if (event.code === 4001) {
                            appendLog(
                                "Authentication required. Redirecting to login...",
                            );
                            window.location.href = "/login";
                            return;
                        }

                        appendLog("Connection lost. Reconnecting...");

                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            setTimeout(connect, 5000);
                        } else {
                            appendLog(
                                "Failed to reconnect. Please refresh the page.",
                            );
                        }
                    };
                } catch (error) {
                    console.error("Connection error:", error);
                    appendLog("Failed to connect to server.");
                }
            }

            downloadBtn.onclick = () => {
                const url = urlInput.value.trim();
                const playlist = playlistInput.value.trim();
                if (!url) {
                    alert("Please enter a Spotify URL.");
                    return;
                }

                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    alert(
                        "Not connected to server. Please wait for connection.",
                    );
                    return;
                }

                terminal.value = "";
                resetProgress();

                try {
                    socket.send(url + "---" + playlist);
                    downloadBtn.disabled = true;
                    urlInput.disabled = true;
                    playlistInput.disabled = true;
                } catch (error) {
                    console.error("Send error:", error);
                    appendLog("Failed to send download request.");
                    downloadBtn.disabled = false;
                    urlInput.disabled = false;
                    playlistInput.disabled = false;
                }
            };

            // Check if we have a session token before connecting
            if (sessionToken) {
                connect();
            } else {
                appendLog("No session token found. Redirecting to login...");
                window.location.href = "/login";
            }
        </script>
    </body>
</html>
